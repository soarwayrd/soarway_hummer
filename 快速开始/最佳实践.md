>阅读此文当前，希望您已经完成[快速开始](./SUMMARY.md)的阅读。[最佳实践](./最佳实践.md)其实就是将编码工作进行**套路化总结**的一个过程。这过程大致分为以下几个步骤：

> 1. 创建DbSet。
> 2. 定义仓储接口。
> 3. 定义仓储实现, 并添加仓储接口与仓储实现的IOC容器配置。
> 4. 添加Webapi, 通过构造器注入，得到仓储对象实例，操作数据库。
> 5. 创建DTO，及DbSet与DTO间的AutoMapper映射。
> 6. 调用PostMan，测试接口，验证返回值是否正确。

1. 打开**Soarway.Hummer.Demo.sln**, 按以下目录结构逐一创建**解决方案虚拟文件夹**，并将各个项目按以下方式存放于各个虚拟文件夹内。目前dotnet cli还暂时没法创建虚拟文件夹，故这个过程需要在**Visual Studio**内手动创建。*Core* 存放框架项目 ; *Biz* 存放业务项目。
```
├─Infrastructure
│  ├─Biz
│  │      Soarway.Hummer.Demo.DTO.csproj
│  │      Soarway.Hummer.Demo.Intrastructure.csproj
│  │      
│  └─Core
│          Soarway.Hummer.Core.DTO.csproj
│          Soarway.Hummer.Core.Intrastructure.csproj
│          
├─Repository
│  ├─Biz
│  │      Soarway.Hummer.Demo.DbSet.csproj
│  │      Soarway.Hummer.Demo.IRepository.csproj
│  │      Soarway.Hummer.Demo.Repository.csproj
│  │      
│  └─Core
│          Soarway.Hummer.Core.DbSet.csproj
│          Soarway.Hummer.Core.IRepository.csproj
│          Soarway.Hummer.Core.Repository.csproj
│          
└─Service
    ├─Biz
    │      Soarway.Hummer.Demo.API.csproj
    │      
    └─Core
            Soarway.Hummer.Core.API.csproj
            
```
1. 找到*Soarway.Hummer.Demo.DbSet*项目, 新建一个**CustomerDbSet**文件夹，在文件夹内添加两个文件*Customer.cs*和*CustomerConfiguration.cs*, 第一个用于定义实体，第二个用于修饰实体。
>推荐尽可能精简namespace，统一采用根一级的namespace，避免添加引用和改动代码的成本。Visual Studio默认的命名规则为每一个文件夹一层命名空间，实践来看没有必要。
```C#
// Customer.cs
public class Customer
{
    /// <summary>
    /// 客户ID
    /// </summary>
    public int CustomerID { get; set; }
    /// <summary>
    /// 客户名称
    /// </summary>
    public string Name { get; set; }
    /// <summary>
    /// 客户分类
    /// </summary>
    public string Class { get; set; }
}
```

```C#
//CustomerConfiguration.cs
public class CustomerConfiguration : IEntityTypeConfiguration<Customer>
{
    public void Configure(EntityTypeBuilder<Customer> builder)
    {
        //table
        builder.ToTable($"{typeof(Customer).Name}");

        //key
        builder.HasKey(p => p.CustomerID);

        //properties
        builder.Property(p => p.Name).HasMaxLength(128).IsRequired();
        builder.Property(p => p.Class).HasMaxLength(10).HasDefaultValue(null).IsRequired(false);       
    }
}
```

3. 找到*Soarway.Hummer.SmartBuilding.IRepository*项目, 添加*ICustomerRepository.cs*接口文件, 并实现如下代码。
>此处仅以举例需要，定义一个Create方法，用于后续测试接口对仓储层的依赖注入。

```C#
public interface ICustomerRepository
{
    int Create(Customer customer);
}
```

4. 找到*Soarway.Hummer.SmartBuilding.Repository*项目，添加*DemoRepository.cs*和*CustomerRepository.cs*两个文件，并实现如下代码
>需添加框架仓储层项目*Soarway.Hummer.Core.Repository.EF*的引用，并将*DemoRepository*继承至*EfRepository*

```C#
//DemoRepository.cs
public class DemoRepository : EfRepository
{
    public EfRepositoryEx(IHttpContextAccessor httpContextAccessor)
        : base(httpContextAccessor)
    {
    }

    public EfRepositoryEx()
    {
    }

    public DbSet<Customer> Customer { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // 客户
        modelBuilder.ApplyConfiguration(new CustomerConfiguration());
    }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseLazyLoadingProxies().UseSqlServer(_connection);
        base.OnConfiguring(optionsBuilder);
    }
}
```

```C#
// CustomerRepository.cs
public class CustomerRepository : ICustomerRepository
{
    private EfRepositoryEx repository;
    public CustomerRepository(EfRepositoryEx efRepositoryEx)
    {
        repository = efRepositoryEx;
    }

    public int Create(Customer customer)
    {
        repository.Customer.Add(customer);
        return repository.SaveChanges();
    }
}
```
